<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI ç”µå•†è§†è§‰ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      .result-editable.modified { border-color: rgba(99, 102, 241, 0.6); box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3); }
      .card-image-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; }
      .card-image-loading .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.2); border-top-color: rgb(99 102 241); border-radius: 50%; animation: card-spin 0.8s linear infinite; }
      @keyframes card-spin { to { transform: rotate(360deg); } }
      .card-image-loading .progress-bar { width: 80%; max-width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
      .card-image-loading .progress-bar-inner { height: 100%; background: linear-gradient(90deg, rgb(99 102 241), rgb(34 211 238)); border-radius: 3px; animation: card-progress 1.5s ease-in-out infinite; }
      @keyframes card-progress { 0% { width: 20%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 20%; margin-left: 80%; } }
      #historySidebar { transition: transform 0.2s ease; transform: translateX(0); }
      #historySidebar.hidden { transform: translateX(-100%); }
      #historyOverlay.hidden { pointer-events: none; opacity: 0; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 antialiased flex flex-col">
    <!-- Header + å†å²è®°å½•å…¥å£ -->
    <header class="shrink-0 border-b border-slate-700/80 bg-slate-950/90 backdrop-blur">
      <div class="flex items-center justify-between gap-3 px-4 py-3">
        <div class="flex items-center gap-3">
          <div class="grid h-8 w-8 place-items-center rounded-lg bg-gradient-to-br from-indigo-500 to-cyan-400 text-slate-950 font-black text-sm">AI</div>
          <h1 class="text-base font-semibold tracking-tight text-slate-100">AI ç”µå•†è§†è§‰ç”Ÿæˆå™¨</h1>
        </div>
        <button id="historyToggle" type="button" class="rounded-lg border border-slate-600 bg-slate-800/80 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" aria-label="å†å²è®°å½•">
          å†å²è®°å½•
        </button>
      </div>
    </header>

    <!-- å†å²è®°å½•ä¾§è¾¹æ ï¼šå·¦ä¾§æ»‘å‡º -->
    <div id="historySidebar" class="hidden fixed left-0 top-0 z-40 h-full w-64 border-r border-slate-700 bg-slate-900 shadow-xl flex flex-col" aria-hidden="true">
      <div class="flex items-center justify-between border-b border-slate-700 px-4 py-3">
        <span class="text-sm font-semibold text-slate-200">å†å²è®°å½•</span>
        <button id="historyClose" type="button" class="rounded p-1 text-slate-400 hover:bg-slate-700 hover:text-slate-200" aria-label="å…³é—­">Ã—</button>
      </div>
      <div id="historyList" class="flex-1 overflow-y-auto p-2 space-y-1">
        <p id="historyEmpty" class="hidden text-center text-sm text-slate-500 py-6">æš‚æ— è®°å½•</p>
        <p id="historyLoading" class="text-center text-sm text-slate-500 py-6">åŠ è½½ä¸­...</p>
      </div>
    </div>
    <div id="historyOverlay" class="hidden fixed inset-0 z-30 bg-black/40" aria-hidden="true"></div>

    <!-- Root: single row, full height, left 40% | right 60% -->
    <div class="flex flex-1 min-h-0">
      <!-- Left column: ç´ æä¸æ–‡æ¡ˆ -->
      <aside class="flex flex-col w-[40%] min-w-0 min-h-0 border-r border-slate-700">
        <div class="flex flex-col flex-1 min-h-0 overflow-auto p-4 space-y-4">
          <!-- 1. Upload -->
          <section>
            <div
              id="uploadZone"
              class="group relative overflow-hidden rounded-xl border border-white/10 bg-white/5 transition hover:bg-white/7"
            >
              <label for="file" class="block cursor-pointer p-4" aria-label="ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ äº§å“ç™½åº•å›¾">
                <div
                  id="dropzone"
                  class="flex min-h-32 flex-col items-center justify-center rounded-lg border-2 border-dashed border-white/20 bg-slate-900/40 px-4 py-6 text-center transition group-hover:border-indigo-400/60 group-hover:bg-slate-900/60"
                >
                  <div class="mb-2 rounded-xl border border-white/10 bg-white/5 p-2">
                    <svg class="h-6 w-6 text-slate-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M12 16V8m0 0l-3 3m3-3l3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M20 16.5c0 2-1.5 3.5-3.5 3.5h-9C5.5 20 4 18.5 4 16.5c0-1.9 1.4-3.4 3.2-3.5.6-2.5 2.8-4.4 5.5-4.4 2.9 0 5.3 2.1 5.7 4.9 1.4.4 2.6 1.6 2.6 3.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </div>
                  <p class="text-sm font-semibold text-slate-100">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ äº§å“ç™½åº•å›¾</p>
                  <p class="mt-0.5 text-xs text-slate-400">æ”¯æŒ PNG / JPGï¼Œå»ºè®®æ–¹å›¾æˆ– 3:4 ç«–å›¾</p>
                  <p id="fileName" class="mt-2 text-[11px] text-slate-500"></p>
                </div>
              </label>
              <input id="file" type="file" accept="image/*" multiple class="sr-only" />
            </div>
            <div class="mt-3 rounded-lg border border-dashed border-white/15 bg-slate-900/40 p-3">
              <div class="mb-2 flex items-center justify-between">
                <span class="text-xs font-medium text-slate-300">é¢„è§ˆï¼ˆæœ€å¤š 20 å¼ ï¼‰</span>
                <span id="previewCount" class="text-[11px] text-slate-500"></span>
              </div>
              <div id="previewGrid" class="flex flex-wrap gap-2"></div>
              <div class="mt-3">
                <button
                  id="analyzeBtn"
                  type="button"
                  disabled
                  class="inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-500 px-4 py-2 text-xs font-semibold text-white transition hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  <span id="analyzeBtnText">å¼€å§‹è§£æ</span>
                  <svg id="analyzeBtnSpinner" class="hidden h-3.5 w-3.5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </section>

          <!-- 2. ä¸­æ–‡å–ç‚¹å‚è€ƒ -->
          <section>
            <h2 class="text-sm font-semibold text-slate-300 mb-1.5">ä¸­æ–‡å–ç‚¹å‚è€ƒ</h2>
            <div
              id="chineseRef"
              contenteditable="true"
              class="min-h-[100px] rounded-lg border border-white/10 bg-slate-800/40 px-3 py-2.5 text-sm leading-relaxed text-slate-300 outline-none focus:border-slate-500 focus:ring-1 focus:ring-slate-500/50"
              data-placeholder="ä¸Šä¼ åç‚¹å‡»ã€Œå¼€å§‹è§£æã€æˆ–åœ¨æ­¤ç›´æ¥è¾“å…¥/ç²˜è´´ä¸­æ–‡å–ç‚¹"
            ></div>
          </section>

          <!-- 3. æ—¥æ–‡æœ¬åœŸåŒ–æ–‡æ¡ˆï¼ˆæœ€ç»ˆç¡®è®¤ç‰ˆï¼‰ -->
          <section>
            <h2 class="text-sm font-semibold text-slate-300 mb-1.5">æ—¥æ–‡æœ¬åœŸåŒ–æ–‡æ¡ˆï¼ˆæœ€ç»ˆç¡®è®¤ç‰ˆï¼‰</h2>
            <div
              id="japaneseFinal"
              contenteditable="true"
              class="min-h-[120px] rounded-lg border-2 border-indigo-500/60 bg-slate-100 text-slate-800 px-3 py-2.5 text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/30"
              data-placeholder="è§£æåå°†æ˜¾ç¤ºæ—¥æ–‡æ–‡æ¡ˆï¼Œå¯åœ¨æ­¤ç¼–è¾‘ç¡®è®¤"
            ></div>
          </section>

          <!-- 4. ä¸»æ“ä½œæŒ‰é’®ï¼ˆä¸¤æ­¥ï¼šå…ˆç”Ÿæˆ Promptï¼Œå†ç”Ÿæˆå›¾ç‰‡ï¼‰ -->
          <section class="pt-2">
            <button
              id="confirmAndGenerate"
              type="button"
              class="w-full rounded-xl bg-indigo-600 py-3.5 text-base font-semibold text-white shadow-sm transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-slate-950"
            >
              ç”Ÿæˆç”Ÿå›¾ Prompt
            </button>
          </section>
        </div>
      </aside>

      <!-- Right column: è§†è§‰ç»“æœ -->
      <main class="flex-1 min-h-0 overflow-y-auto bg-slate-900/30">
        <div class="p-4 sm:p-6 space-y-6">
          <!-- Card 1: é«˜æ¸…ç™½åº•å›¾ -->
          <article id="card1" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="1">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">1. é«˜æ¸…ç™½åº•å›¾</h3>
              <div id="card1Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                å ä½å›¾
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-slate-400 mb-1">ä¸­æ–‡è¯´æ˜</label>
                <div id="card1PromptZh" class="mb-2 rounded-lg border border-white/10 bg-slate-800/30 px-3 py-2 text-sm text-slate-400 min-h-[2.5rem]">â€”</div>
                <label for="card1Prompt" class="block text-xs font-medium text-slate-400 mb-1">è‹±æ–‡ç”Ÿå›¾æç¤ºè¯ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
                <textarea id="card1Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ç­‰å¾…ç”Ÿæˆ...">ç­‰å¾…ç”Ÿæˆ...</textarea>
              </div>
              <button id="card1Redraw" type="button" data-card="1" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                ä¿®æ”¹æç¤ºè¯å¹¶å•ç‹¬é‡ç»˜
              </button>
            </div>
          </article>

          <!-- Card 2: äº§å“ä¸»å›¾ -->
          <article id="card2" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="2">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">2. äº§å“ä¸»å›¾</h3>
              <div id="card2Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                å ä½å›¾
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-slate-400 mb-1">ä¸­æ–‡è¯´æ˜</label>
                <div id="card2PromptZh" class="mb-2 rounded-lg border border-white/10 bg-slate-800/30 px-3 py-2 text-sm text-slate-400 min-h-[2.5rem]">â€”</div>
                <label for="card2Prompt" class="block text-xs font-medium text-slate-400 mb-1">è‹±æ–‡ç”Ÿå›¾æç¤ºè¯ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
                <textarea id="card2Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ç­‰å¾…ç”Ÿæˆ...">ç­‰å¾…ç”Ÿæˆ...</textarea>
              </div>
              <button id="card2Redraw" type="button" data-card="2" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                ä¿®æ”¹æç¤ºè¯å¹¶å•ç‹¬é‡ç»˜
              </button>
            </div>
          </article>

          <!-- Card 3: äº§å“åŠŸèƒ½å–ç‚¹ä»‹ç»å›¾ -->
          <article id="card3" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="3">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">3. äº§å“åŠŸèƒ½å–ç‚¹ä»‹ç»å›¾</h3>
              <div id="card3Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                å ä½å›¾
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-slate-400 mb-1">ä¸­æ–‡è¯´æ˜</label>
                <div id="card3PromptZh" class="mb-2 rounded-lg border border-white/10 bg-slate-800/30 px-3 py-2 text-sm text-slate-400 min-h-[2.5rem]">â€”</div>
                <label for="card3Prompt" class="block text-xs font-medium text-slate-400 mb-1">è‹±æ–‡ç”Ÿå›¾æç¤ºè¯ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
                <textarea id="card3Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ç­‰å¾…ç”Ÿæˆ...">ç­‰å¾…ç”Ÿæˆ...</textarea>
              </div>
              <button id="card3Redraw" type="button" data-card="3" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                ä¿®æ”¹æç¤ºè¯å¹¶å•ç‹¬é‡ç»˜
              </button>
            </div>
          </article>

          <!-- Card 4: äº§å“åœºæ™¯å›¾ -->
          <article id="card4" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="4">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">4. äº§å“åœºæ™¯å›¾</h3>
              <div id="card4Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                å ä½å›¾
              </div>
              <div class="mt-3">
                <label class="block text-xs font-medium text-slate-400 mb-1">ä¸­æ–‡è¯´æ˜</label>
                <div id="card4PromptZh" class="mb-2 rounded-lg border border-white/10 bg-slate-800/30 px-3 py-2 text-sm text-slate-400 min-h-[2.5rem]">â€”</div>
                <label for="card4Prompt" class="block text-xs font-medium text-slate-400 mb-1">è‹±æ–‡ç”Ÿå›¾æç¤ºè¯ï¼ˆå¯ç¼–è¾‘ï¼‰</label>
                <textarea id="card4Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ç­‰å¾…ç”Ÿæˆ...">ç­‰å¾…ç”Ÿæˆ...</textarea>
              </div>
              <button id="card4Redraw" type="button" data-card="4" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                ä¿®æ”¹æç¤ºè¯å¹¶å•ç‹¬é‡ç»˜
              </button>
            </div>
          </article>

          <!-- ç¡®è®¤ Prompt å¹¶ç”Ÿæˆå…¨éƒ¨å›¾ç‰‡ + æ‰“åŒ…ä¸‹è½½ -->
          <section class="rounded-xl border border-white/10 bg-white/5 p-4 sm:p-5 space-y-3">
            <button
              id="confirmPromptAndGenerate"
              type="button"
              class="w-full rounded-xl bg-indigo-600 py-3 text-base font-semibold text-white shadow-sm transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-slate-950"
            >
              ç¡®è®¤ Prompt å¹¶ç”Ÿæˆå…¨éƒ¨å›¾ç‰‡
            </button>
            <button
              id="packDownloadBtn"
              type="button"
              class="w-full rounded-xl border border-white/20 bg-slate-800/80 py-3 text-base font-semibold text-slate-200 transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50"
            >
              ğŸ“¦ æ‰“åŒ…ä¸‹è½½
            </button>
          </section>
        </div>
      </main>
    </div>

    <script>
      const input = document.getElementById("file");
      const dropzone = document.getElementById("dropzone");
      const fileName = document.getElementById("fileName");
      const previewGrid = document.getElementById("previewGrid");
      const previewCount = document.getElementById("previewCount");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const analyzeBtnText = document.getElementById("analyzeBtnText");
      const analyzeBtnSpinner = document.getElementById("analyzeBtnSpinner");
      const chineseRef = document.getElementById("chineseRef");
      const japaneseFinal = document.getElementById("japaneseFinal");
      const confirmAndGenerate = document.getElementById("confirmAndGenerate");
      const historyToggle = document.getElementById("historyToggle");
      const historySidebar = document.getElementById("historySidebar");
      const historyClose = document.getElementById("historyClose");
      const historyOverlay = document.getElementById("historyOverlay");
      const historyList = document.getElementById("historyList");
      const historyEmpty = document.getElementById("historyEmpty");
      const historyLoading = document.getElementById("historyLoading");

      /** @type {Array<{id:string, file:File, url:string}>} */
      let previewItems = [];
      let analyzeLoading = false;

      function refreshPreview() {
        previewGrid.innerHTML = "";
        const visibleItems = previewItems.slice(0, 20);
        visibleItems.forEach((item, index) => {
          const wrapper = document.createElement("div");
          wrapper.id = item.id;
          wrapper.className = "relative h-20 w-20 overflow-hidden rounded-lg border border-white/10 bg-slate-900/60";
          const numberBadge = document.createElement("span");
          numberBadge.className = "absolute left-1 top-1 flex h-4 min-w-4 items-center justify-center rounded bg-slate-800 text-[10px] font-semibold text-slate-200";
          numberBadge.textContent = String(index + 1);
          const img = document.createElement("img");
          img.src = item.url;
          img.alt = item.file.name;
          img.className = "h-full w-full object-cover";
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "absolute right-1 top-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500/80 text-white text-[10px] font-bold hover:bg-red-400";
          removeBtn.innerHTML = "Ã—";
          removeBtn.title = "ç§»é™¤";
          removeBtn.addEventListener("click", () => {
            previewItems = previewItems.filter((x) => x.id !== item.id);
            URL.revokeObjectURL(item.url);
            refreshPreview();
          });
          wrapper.appendChild(numberBadge);
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          previewGrid.appendChild(wrapper);
        });
        if (previewItems.length === 0) {
          previewCount.textContent = "";
          if (analyzeBtn) analyzeBtn.disabled = true;
          return;
        }
        previewCount.textContent = `å·²é€‰æ‹© ${previewItems.length} å¼ `;
        if (analyzeBtn) analyzeBtn.disabled = false;
      }

      function addFiles(files) {
        if (!files || !files.length) return;
        const imageFiles = Array.from(files).filter((f) => f.type.startsWith("image/"));
        if (!imageFiles.length) return;
        imageFiles.forEach((file) => {
          const id = `${file.name}-${file.lastModified}-${Math.random().toString(36).slice(2, 8)}`;
          previewItems.push({ id, file, url: URL.createObjectURL(file) });
        });
        fileName.textContent = imageFiles.length === 1 ? `å·²é€‰æ‹©ï¼š${imageFiles[0].name}` : `å·²é€‰æ‹© ${imageFiles.length} å¼ å›¾ç‰‡`;
        refreshPreview();
      }

      input.addEventListener("change", () => addFiles(input.files));
      ["dragenter", "dragover"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add("ring-2", "ring-indigo-400/60", "border-indigo-400/60"); });
      });
      ["dragleave", "drop"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("ring-2", "ring-indigo-400/60", "border-indigo-400/60"); });
      });
      dropzone.addEventListener("drop", (e) => { const f = e.dataTransfer?.files; if (f?.length) addFiles(f); });

      // å¼€å§‹è§£æ â†’ å¡«å…… #chineseRef ä¸ #japaneseFinal
      analyzeBtn.addEventListener("click", async () => {
        if (analyzeLoading || previewItems.length === 0) return;
        const file = previewItems[0].file;
        const formData = new FormData();
        formData.append("image", file);
        analyzeLoading = true;
        analyzeBtn.disabled = true;
        analyzeBtnText.textContent = "AI æ­£åœ¨æ€è€ƒä¸­...";
        analyzeBtnSpinner.classList.remove("hidden");
        try {
          const res = await fetch("/analyze-product", { method: "POST", body: formData });
          const json = await res.json();
          if (!res.ok) {
            alert("è§£æå¤±è´¥ï¼š\n" + (json.message || json.error || "è¯·æ±‚å¤±è´¥"));
            return;
          }
          if (!json.success || !json.data) {
            alert("è§£æå¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›æ•°æ®å¼‚å¸¸");
            return;
          }
          const data = json.data;
          const chineseIntro = (data.chinese && data.chinese["äº§å“ç®€ä»‹"] != null) ? String(data.chinese["äº§å“ç®€ä»‹"]) : "";
          const chinesePoints = Array.isArray(data.chinese && data.chinese["æ ¸å¿ƒå–ç‚¹"]) ? data.chinese["æ ¸å¿ƒå–ç‚¹"] : [];
          const chineseText = [chineseIntro, ...chinesePoints].filter(Boolean).join("\n\n");
          chineseRef.textContent = chineseText;

          let japaneseIntro = (data.japanese && data.japanese["æœ¬åœŸåŒ–ç®€ä»‹"] != null) ? String(data.japanese["æœ¬åœŸåŒ–ç®€ä»‹"]).trim() : "";
          let japanesePoints = Array.isArray(data.japanese?.["æœ¬åœŸåŒ–å–ç‚¹"]) ? data.japanese["æœ¬åœŸåŒ–å–ç‚¹"] : [];
          if (!data.japanese && Array.isArray(data["æ ¸å¿ƒå–ç‚¹"])) {
            japanesePoints = data["æ ¸å¿ƒå–ç‚¹"];
            japaneseIntro = data["äº§å“åç§°"] != null ? String(data["äº§å“åç§°"]) : "";
          }
          const japaneseText = [japaneseIntro, ...japanesePoints.map((p) => String(p).trim())].filter(Boolean).join("\n\n");
          japaneseFinal.textContent = japaneseText;
        } catch (e) {
          alert("è§£æå¤±è´¥ï¼š\n" + (e.message || "ç½‘ç»œé”™è¯¯"));
        } finally {
          analyzeLoading = false;
          analyzeBtn.disabled = previewItems.length === 0;
          analyzeBtnText.textContent = "å¼€å§‹è§£æ";
          analyzeBtnSpinner.classList.add("hidden");
        }
      });

      // ---------- å³ä¾§å¡ç‰‡ï¼šåŠ è½½æ€ / ç»“æœæ¸²æŸ“ / é‡ç»˜ ----------
      function setCardLoading(cardIndex) {
        const el = document.getElementById(`card${cardIndex}Image`);
        if (!el) return;
        el.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/60 flex card-image-loading text-slate-300 text-sm";
        el.innerHTML = '<div class="spinner" aria-hidden="true"></div><span>AI æ­£åœ¨ä½œç”»ä¸­...</span><div class="progress-bar"><div class="progress-bar-inner"></div></div>';
      }

      function setCardResult(cardIndex, url, promptEn, promptZh) {
        const imageEl = document.getElementById(`card${cardIndex}Image`);
        const promptEl = document.getElementById(`card${cardIndex}Prompt`);
        const promptZhEl = document.getElementById(`card${cardIndex}PromptZh`);
        const redrawBtn = document.getElementById(`card${cardIndex}Redraw`);
        if (imageEl) {
          imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 overflow-hidden flex items-center justify-center";
          imageEl.innerHTML = '';
          if (url) {
            const img = document.createElement('img');
            img.src = url;
            img.alt = 'ç”Ÿæˆå›¾';
            img.className = 'w-full h-full object-contain';
            imageEl.appendChild(img);
          } else {
            const span = document.createElement('span');
            span.className = 'text-amber-400 text-sm';
            span.textContent = 'ç”Ÿæˆå¤±è´¥';
            imageEl.appendChild(span);
          }
        }
        if (promptEl) promptEl.value = (promptEn != null ? promptEn : '') || '';
        if (promptZhEl) promptZhEl.textContent = (promptZh != null ? promptZh : '') || 'â€”';
        if (redrawBtn) {
          redrawBtn.disabled = !url;
          if (url) redrawBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          else redrawBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      function setRedrawButtonsEnabled(enabled) {
        [1, 2, 3, 4].forEach((i) => {
          const btn = document.getElementById(`card${i}Redraw`);
          if (btn) {
            btn.disabled = !enabled;
            if (enabled) btn.classList.remove('opacity-50', 'cursor-not-allowed');
            else btn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        });
      }

      // ---------- å†å²è®°å½•ä¾§è¾¹æ  ----------
      function openHistorySidebar() {
        historySidebar.classList.remove('hidden');
        historySidebar.setAttribute('aria-hidden', 'false');
        historyOverlay.classList.remove('hidden');
        historyOverlay.setAttribute('aria-hidden', 'false');
      }
      function closeHistorySidebar() {
        historySidebar.classList.add('hidden');
        historySidebar.setAttribute('aria-hidden', 'true');
        historyOverlay.classList.add('hidden');
        historyOverlay.setAttribute('aria-hidden', 'true');
      }

      function formatHistoryTime(createdAt) {
        if (!createdAt) return '';
        const d = new Date(createdAt);
        const now = new Date();
        const sameDay = d.toDateString() === now.toDateString();
        if (sameDay) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        return d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      }

      function fillFromHistory(row) {
        chineseRef.textContent = row.chinese_text || '';
        japaneseFinal.textContent = row.japanese_text || '';
        let urls = [];
        let prompts = [];
        try {
          if (row.image_urls) urls = JSON.parse(row.image_urls);
          if (row.prompts_json) prompts = JSON.parse(row.prompts_json);
        } catch (e) {}
        [1, 2, 3, 4].forEach((i) => setCardResult(i, urls[i - 1] || null, prompts[i - 1] || '', ''));
        closeHistorySidebar();
      }

      async function loadHistory() {
        historyLoading.classList.remove('hidden');
        historyEmpty.classList.add('hidden');
        historyList.querySelectorAll('.history-item').forEach((el) => el.remove());
        try {
          const res = await fetch('/api/history');
          const rows = await res.json();
          historyLoading.classList.add('hidden');
          if (!Array.isArray(rows) || rows.length === 0) {
            historyEmpty.classList.remove('hidden');
            return;
          }
          rows.slice(0, 10).forEach((row) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'history-item w-full text-left rounded-lg border border-slate-700 bg-slate-800/60 px-3 py-2.5 hover:bg-slate-700/80 focus:outline-none focus:ring-2 focus:ring-indigo-500/50';
            const name = document.createElement('div');
            name.className = 'text-sm font-medium text-slate-200 truncate';
            name.textContent = row.product_name || 'ï¼ˆæœªå‘½åï¼‰';
            const time = document.createElement('div');
            time.className = 'text-xs text-slate-400 mt-0.5';
            time.textContent = formatHistoryTime(row.created_at);
            item.appendChild(name);
            item.appendChild(time);
            item.addEventListener('click', () => fillFromHistory(row));
            historyList.appendChild(item);
          });
        } catch (e) {
          historyLoading.classList.add('hidden');
          historyEmpty.classList.remove('hidden');
          historyEmpty.textContent = 'åŠ è½½å¤±è´¥';
        }
      }

      historyToggle.addEventListener('click', () => { openHistorySidebar(); loadHistory(); });
      historyClose.addEventListener('click', closeHistorySidebar);
      historyOverlay.addEventListener('click', closeHistorySidebar);

      document.addEventListener('DOMContentLoaded', loadHistory);

      const PROMPT_ORDER = ['pure_product', 'main_image', 'infographic', 'lifestyle'];

      // ç”Ÿæˆç”Ÿå›¾ Promptï¼ˆä»…ç”Ÿæˆ 4 æ®µä¸­è‹±æ–‡ Promptï¼Œä¸ç”Ÿå›¾ï¼‰
      let generatePromptLoading = false;
      confirmAndGenerate.addEventListener("click", async () => {
        const japaneseText = (japaneseFinal.innerText || japaneseFinal.textContent || '').trim();
        const chineseText = (chineseRef.textContent || '').trim();
        if (!japaneseText && !chineseText) {
          alert('è¯·å…ˆå¡«å†™æˆ–è§£æå‡ºã€Œä¸­æ–‡/æ—¥æ–‡æ–‡æ¡ˆã€åå†ç”Ÿæˆ Promptã€‚');
          return;
        }
        if (generatePromptLoading) return;
        generatePromptLoading = true;
        confirmAndGenerate.disabled = true;
        try {
          const res = await fetch('/generate-prompts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ japaneseText, chineseText }),
          });
          const json = await res.json();
          if (!res.ok) {
            alert('Prompt ç”Ÿæˆå¤±è´¥ï¼š' + (json.message || json.error || res.statusText));
            return;
          }
          if (!json.success || !json.data) {
            alert('Prompt ç”Ÿæˆå¤±è´¥ï¼šè¿”å›æ•°æ®å¼‚å¸¸');
            return;
          }
          const data = json.data;
          [1, 2, 3, 4].forEach((i) => {
            const key = PROMPT_ORDER[i - 1];
            const item = data[key];
            const zh = item && item.zh ? String(item.zh) : '';
            const en = item && item.en ? String(item.en) : '';
            setCardResult(i, null, en, zh);
          });
        } catch (e) {
          alert('Prompt ç”Ÿæˆå¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯'));
        } finally {
          generatePromptLoading = false;
          confirmAndGenerate.disabled = false;
        }
      });

      // ç¡®è®¤ Prompt å¹¶ç”Ÿæˆå…¨éƒ¨å›¾ç‰‡
      const confirmPromptAndGenerate = document.getElementById('confirmPromptAndGenerate');
      let generateImagesLoading = false;
      confirmPromptAndGenerate.addEventListener('click', async () => {
        const prompts = [1, 2, 3, 4].map((i) => {
          const el = document.getElementById(`card${i}Prompt`);
          return el ? String(el.value || '').trim() : '';
        });
        if (prompts.some((p) => !p)) {
          alert('è¯·å…ˆç‚¹å‡»ã€Œç”Ÿæˆç”Ÿå›¾ Promptã€å¹¶ç¡®ä¿ 4 å¼ å¡ç‰‡çš„è‹±æ–‡æç¤ºè¯å‡å·²å¡«å†™ã€‚');
          return;
        }
        if (generateImagesLoading) return;
        generateImagesLoading = true;
        confirmPromptAndGenerate.disabled = true;
        [1, 2, 3, 4].forEach(setCardLoading);
        setRedrawButtonsEnabled(false);
        try {
          const productName = previewItems.length > 0 ? (previewItems[0].file.name || '').trim() : '';
          const chineseText = (chineseRef.textContent || '').trim();
          const japaneseText = (japaneseFinal.innerText || japaneseFinal.textContent || '').trim();
          const res = await fetch('/generate-images', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompts, product_name: productName, chineseText, japaneseText }),
          });
          const json = await res.json();
          if (!res.ok) {
            alert('ç”Ÿæˆå¤±è´¥ï¼š' + (json.message || json.error || res.statusText));
            [1, 2, 3, 4].forEach((i) => setCardResult(i, null, prompts[i - 1], ''));
            return;
          }
          if (!json.success || !Array.isArray(json.data)) {
            alert('ç”Ÿæˆå¤±è´¥ï¼šè¿”å›æ•°æ®å¼‚å¸¸');
            [1, 2, 3, 4].forEach((i) => setCardResult(i, null, prompts[i - 1], ''));
            return;
          }
          json.data.forEach((item, index) => {
            const i = index + 1;
            const promptEl = document.getElementById(`card${i}Prompt`);
            const promptZhEl = document.getElementById(`card${i}PromptZh`);
            setCardResult(i, item.url || null, item.prompt || (promptEl && promptEl.value) || '', (promptZhEl && promptZhEl.textContent) || '');
          });
        } catch (e) {
          alert('ç”Ÿæˆå¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯'));
          [1, 2, 3, 4].forEach((i) => {
            const promptEl = document.getElementById(`card${i}Prompt`);
            setCardResult(i, null, promptEl ? promptEl.value : '', '');
          });
        } finally {
          generateImagesLoading = false;
          confirmPromptAndGenerate.disabled = false;
        }
      });

      // ä¿®æ”¹æç¤ºè¯å¹¶å•ç‹¬é‡ç»˜ï¼šè°ƒç”¨ /regenerate-singleï¼ŒæŒ‰ type æ›´æ–°å¯¹åº”å¡ç‰‡å›¾ç‰‡
      const cardTypes = { 1: 'ç™½åº•å›¾', 2: 'ä¸»å›¾', 3: 'å–ç‚¹å›¾', 4: 'åœºæ™¯å›¾' };
      [1, 2, 3, 4].forEach((i) => {
        const btn = document.getElementById(`card${i}Redraw`);
        const promptEl = document.getElementById(`card${i}Prompt`);
        const imageEl = document.getElementById(`card${i}Image`);
        if (!btn || !promptEl) return;
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.addEventListener('click', async () => {
          const prompt = promptEl.value.trim();
          if (!prompt) {
            alert('è¯·å…ˆå¡«å†™æˆ–ç”Ÿæˆç”Ÿå›¾æç¤ºè¯åå†é‡ç»˜ã€‚');
            return;
          }
          btn.disabled = true;
          setCardLoading(i);
          try {
            const res = await fetch('/regenerate-single', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, type: cardTypes[i] }),
            });
            const json = await res.json();
            if (!json.success) {
              alert('é‡ç»˜å¤±è´¥ï¼š' + (json.message || 'æœªçŸ¥é”™è¯¯'));
              if (imageEl) {
                imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-amber-400 text-sm";
                imageEl.textContent = 'é‡ç»˜å¤±è´¥';
              }
              return;
            }
            if (imageEl && json.url) {
              imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 overflow-hidden flex items-center justify-center";
              imageEl.innerHTML = '';
              const img = document.createElement('img');
              img.src = json.url;
              img.alt = 'é‡ç»˜å›¾';
              img.className = 'w-full h-full object-contain';
              imageEl.appendChild(img);
            }
          } catch (e) {
            alert('é‡ç»˜å¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯'));
            if (imageEl) {
              imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-amber-400 text-sm";
              imageEl.textContent = 'é‡ç»˜å¤±è´¥';
            }
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        });
      });

      // æ‰“åŒ…ä¸‹è½½ï¼š4 å¼ å¡ç‰‡å›¾ç‰‡ + æ–‡æ¡ˆ TXTï¼Œé€šè¿‡ä»£ç† fetch è½¬ Blob åæ‰“ ZIP
      const packDownloadBtn = document.getElementById('packDownloadBtn');
      packDownloadBtn.addEventListener('click', async () => {
        const chineseText = (chineseRef.textContent || '').trim();
        const japaneseText = (japaneseFinal.innerText || japaneseFinal.textContent || '').trim();
        const names = ['1-é«˜æ¸…ç™½åº•å›¾', '2-äº§å“ä¸»å›¾', '3-äº§å“åŠŸèƒ½å–ç‚¹ä»‹ç»å›¾', '4-äº§å“åœºæ™¯å›¾'];
        const urls = [1, 2, 3, 4].map((i) => {
          const el = document.querySelector(`#card${i}Image img`);
          return el && el.src ? el.src : null;
        });
        const hasAny = urls.some(Boolean);
        if (!hasAny) {
          alert('è¯·å…ˆç”Ÿæˆå…¨éƒ¨å›¾ç‰‡åå†æ‰“åŒ…ä¸‹è½½ã€‚');
          return;
        }
        if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
          alert('ç¼ºå°‘ JSZip æˆ– FileSaverï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
          return;
        }
        packDownloadBtn.disabled = true;
        packDownloadBtn.textContent = 'æ­£åœ¨æ‰“åŒ…...';
        try {
          const zip = new JSZip();
          for (let i = 0; i < 4; i++) {
            const url = urls[i];
            if (!url) continue;
            let blob;
            if (url.startsWith('data:')) {
              const res = await fetch(url);
              blob = await res.blob();
            } else {
              const res = await fetch('/api/proxy-image?url=' + encodeURIComponent(url));
              if (!res.ok) throw new Error('å›¾ç‰‡ä¸‹è½½å¤±è´¥: ' + (i + 1));
              blob = await res.blob();
            }
            const ext = (blob.type || '').indexOf('png') >= 0 ? 'png' : 'jpg';
            zip.file(names[i] + '.' + ext, blob);
          }
          const txtContent = [
            '=== ä¸­æ–‡æ–‡æ¡ˆ ===',
            chineseText || 'ï¼ˆæ— ï¼‰',
            '',
            '=== æ—¥æ–‡æ–‡æ¡ˆ ===',
            japaneseText || 'ï¼ˆæ— ï¼‰',
          ].join('\n');
          zip.file('æ–‡æ¡ˆ.txt', txtContent);
          const zipBlob = await zip.generateAsync({ type: 'blob' });
          const fileName = 'ç”µå•†ç»„å›¾_' + new Date().toISOString().slice(0, 10) + '.zip';
          saveAs(zipBlob, fileName);
        } catch (e) {
          alert('æ‰“åŒ…ä¸‹è½½å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
        } finally {
          packDownloadBtn.disabled = false;
          packDownloadBtn.textContent = 'ğŸ“¦ æ‰“åŒ…ä¸‹è½½';
        }
      });
    </script>
  </body>
</html>
