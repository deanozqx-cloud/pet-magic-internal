<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 电商视觉生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .result-editable.modified { border-color: rgba(99, 102, 241, 0.6); box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3); }
      .card-image-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; }
      .card-image-loading .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.2); border-top-color: rgb(99 102 241); border-radius: 50%; animation: card-spin 0.8s linear infinite; }
      @keyframes card-spin { to { transform: rotate(360deg); } }
      .card-image-loading .progress-bar { width: 80%; max-width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
      .card-image-loading .progress-bar-inner { height: 100%; background: linear-gradient(90deg, rgb(99 102 241), rgb(34 211 238)); border-radius: 3px; animation: card-progress 1.5s ease-in-out infinite; }
      @keyframes card-progress { 0% { width: 20%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 20%; margin-left: 80%; } }
      #historySidebar { transition: transform 0.2s ease; transform: translateX(0); }
      #historySidebar.hidden { transform: translateX(-100%); }
      #historyOverlay.hidden { pointer-events: none; opacity: 0; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 antialiased flex flex-col">
    <!-- Header + 历史记录入口 -->
    <header class="shrink-0 border-b border-slate-700/80 bg-slate-950/90 backdrop-blur">
      <div class="flex items-center justify-between gap-3 px-4 py-3">
        <div class="flex items-center gap-3">
          <div class="grid h-8 w-8 place-items-center rounded-lg bg-gradient-to-br from-indigo-500 to-cyan-400 text-slate-950 font-black text-sm">AI</div>
          <h1 class="text-base font-semibold tracking-tight text-slate-100">AI 电商视觉生成器</h1>
        </div>
        <button id="historyToggle" type="button" class="rounded-lg border border-slate-600 bg-slate-800/80 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50" aria-label="历史记录">
          历史记录
        </button>
      </div>
    </header>

    <!-- 历史记录侧边栏：左侧滑出 -->
    <div id="historySidebar" class="hidden fixed left-0 top-0 z-40 h-full w-64 border-r border-slate-700 bg-slate-900 shadow-xl flex flex-col" aria-hidden="true">
      <div class="flex items-center justify-between border-b border-slate-700 px-4 py-3">
        <span class="text-sm font-semibold text-slate-200">历史记录</span>
        <button id="historyClose" type="button" class="rounded p-1 text-slate-400 hover:bg-slate-700 hover:text-slate-200" aria-label="关闭">×</button>
      </div>
      <div id="historyList" class="flex-1 overflow-y-auto p-2 space-y-1">
        <p id="historyEmpty" class="hidden text-center text-sm text-slate-500 py-6">暂无记录</p>
        <p id="historyLoading" class="text-center text-sm text-slate-500 py-6">加载中...</p>
      </div>
    </div>
    <div id="historyOverlay" class="hidden fixed inset-0 z-30 bg-black/40" aria-hidden="true"></div>

    <!-- Root: single row, full height, left 40% | right 60% -->
    <div class="flex flex-1 min-h-0">
      <!-- Left column: 素材与文案 -->
      <aside class="flex flex-col w-[40%] min-w-0 min-h-0 border-r border-slate-700">
        <div class="flex flex-col flex-1 min-h-0 overflow-auto p-4 space-y-4">
          <!-- 1. Upload -->
          <section>
            <div
              id="uploadZone"
              class="group relative overflow-hidden rounded-xl border border-white/10 bg-white/5 transition hover:bg-white/7"
            >
              <label for="file" class="block cursor-pointer p-4" aria-label="点击或拖拽上传产品白底图">
                <div
                  id="dropzone"
                  class="flex min-h-32 flex-col items-center justify-center rounded-lg border-2 border-dashed border-white/20 bg-slate-900/40 px-4 py-6 text-center transition group-hover:border-indigo-400/60 group-hover:bg-slate-900/60"
                >
                  <div class="mb-2 rounded-xl border border-white/10 bg-white/5 p-2">
                    <svg class="h-6 w-6 text-slate-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                      <path d="M12 16V8m0 0l-3 3m3-3l3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M20 16.5c0 2-1.5 3.5-3.5 3.5h-9C5.5 20 4 18.5 4 16.5c0-1.9 1.4-3.4 3.2-3.5.6-2.5 2.8-4.4 5.5-4.4 2.9 0 5.3 2.1 5.7 4.9 1.4.4 2.6 1.6 2.6 3.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </div>
                  <p class="text-sm font-semibold text-slate-100">点击或拖拽上传产品白底图</p>
                  <p class="mt-0.5 text-xs text-slate-400">支持 PNG / JPG，建议方图或 3:4 竖图</p>
                  <p id="fileName" class="mt-2 text-[11px] text-slate-500"></p>
                </div>
              </label>
              <input id="file" type="file" accept="image/*" multiple class="sr-only" />
            </div>
            <div class="mt-3 rounded-lg border border-dashed border-white/15 bg-slate-900/40 p-3">
              <div class="mb-2 flex items-center justify-between">
                <span class="text-xs font-medium text-slate-300">预览（最多 20 张）</span>
                <span id="previewCount" class="text-[11px] text-slate-500"></span>
              </div>
              <div id="previewGrid" class="flex flex-wrap gap-2"></div>
              <div class="mt-3">
                <button
                  id="analyzeBtn"
                  type="button"
                  disabled
                  class="inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-500 px-4 py-2 text-xs font-semibold text-white transition hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 disabled:cursor-not-allowed disabled:opacity-50"
                >
                  <span id="analyzeBtnText">开始解析</span>
                  <svg id="analyzeBtnSpinner" class="hidden h-3.5 w-3.5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>
            </div>
          </section>

          <!-- 2. 中文卖点参考 -->
          <section>
            <h2 class="text-sm font-semibold text-slate-300 mb-1.5">中文卖点参考</h2>
            <div
              id="chineseRef"
              contenteditable="true"
              class="min-h-[100px] rounded-lg border border-white/10 bg-slate-800/40 px-3 py-2.5 text-sm leading-relaxed text-slate-300 outline-none focus:border-slate-500 focus:ring-1 focus:ring-slate-500/50"
              data-placeholder="上传后点击「开始解析」或在此直接输入/粘贴中文卖点"
            ></div>
          </section>

          <!-- 3. 日文本土化文案（最终确认版） -->
          <section>
            <h2 class="text-sm font-semibold text-slate-300 mb-1.5">日文本土化文案（最终确认版）</h2>
            <div
              id="japaneseFinal"
              contenteditable="true"
              class="min-h-[120px] rounded-lg border-2 border-indigo-500/60 bg-slate-100 text-slate-800 px-3 py-2.5 text-sm leading-relaxed outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/30"
              data-placeholder="解析后将显示日文文案，可在此编辑确认"
            ></div>
          </section>

          <!-- 4. 主操作按钮 -->
          <section class="pt-2">
            <button
              id="confirmAndGenerate"
              type="button"
              class="w-full rounded-xl bg-indigo-600 py-3.5 text-base font-semibold text-white shadow-sm transition hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-slate-950"
            >
              确认文案并生成全套组图
            </button>
          </section>
        </div>
      </aside>

      <!-- Right column: 视觉结果 -->
      <main class="flex-1 min-h-0 overflow-y-auto bg-slate-900/30">
        <div class="p-4 sm:p-6 space-y-6">
          <!-- Card 1: 高清白底精修图 -->
          <article id="card1" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="1">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">1. 高清白底精修图</h3>
              <div id="card1Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                占位图
              </div>
              <div class="mt-3">
                <label for="card1Prompt" class="block text-xs font-medium text-slate-400 mb-1">生图提示词（可编辑）</label>
                <textarea id="card1Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="等待生成...">等待生成...</textarea>
              </div>
              <button id="card1Redraw" type="button" data-card="1" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                修改提示词并单独重绘
              </button>
            </div>
          </article>

          <!-- Card 2: 日文卖点可视化图 -->
          <article id="card2" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="2">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">2. 日文卖点可视化图</h3>
              <div id="card2Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                占位图
              </div>
              <div class="mt-3">
                <label for="card2Prompt" class="block text-xs font-medium text-slate-400 mb-1">生图提示词（可编辑）</label>
                <textarea id="card2Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="等待生成...">等待生成...</textarea>
              </div>
              <button id="card2Redraw" type="button" data-card="2" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                修改提示词并单独重绘
              </button>
            </div>
          </article>

          <!-- Card 3: 日本本土场景图 -->
          <article id="card3" class="rounded-xl border border-white/10 bg-white/5 shadow-sm overflow-hidden" data-card-index="3">
            <div class="p-4 sm:p-5">
              <h3 class="text-sm font-semibold text-slate-200">3. 日本本土场景图</h3>
              <div id="card3Image" class="mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-slate-500 text-sm">
                占位图
              </div>
              <div class="mt-3">
                <label for="card3Prompt" class="block text-xs font-medium text-slate-400 mb-1">生图提示词（可编辑）</label>
                <textarea id="card3Prompt" rows="3" class="w-full resize-none rounded-lg border border-white/10 bg-slate-900/50 px-3 py-2 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="等待生成...">等待生成...</textarea>
              </div>
              <button id="card3Redraw" type="button" data-card="3" class="mt-3 w-full rounded-lg border border-white/10 bg-white/5 py-2 text-sm font-medium text-slate-200 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-500/50">
                修改提示词并单独重绘
              </button>
            </div>
          </article>
        </div>
      </main>
    </div>

    <script>
      const input = document.getElementById("file");
      const dropzone = document.getElementById("dropzone");
      const fileName = document.getElementById("fileName");
      const previewGrid = document.getElementById("previewGrid");
      const previewCount = document.getElementById("previewCount");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const analyzeBtnText = document.getElementById("analyzeBtnText");
      const analyzeBtnSpinner = document.getElementById("analyzeBtnSpinner");
      const chineseRef = document.getElementById("chineseRef");
      const japaneseFinal = document.getElementById("japaneseFinal");
      const confirmAndGenerate = document.getElementById("confirmAndGenerate");
      const historyToggle = document.getElementById("historyToggle");
      const historySidebar = document.getElementById("historySidebar");
      const historyClose = document.getElementById("historyClose");
      const historyOverlay = document.getElementById("historyOverlay");
      const historyList = document.getElementById("historyList");
      const historyEmpty = document.getElementById("historyEmpty");
      const historyLoading = document.getElementById("historyLoading");

      /** @type {Array<{id:string, file:File, url:string}>} */
      let previewItems = [];
      let analyzeLoading = false;

      function refreshPreview() {
        previewGrid.innerHTML = "";
        const visibleItems = previewItems.slice(0, 20);
        visibleItems.forEach((item, index) => {
          const wrapper = document.createElement("div");
          wrapper.id = item.id;
          wrapper.className = "relative h-20 w-20 overflow-hidden rounded-lg border border-white/10 bg-slate-900/60";
          const numberBadge = document.createElement("span");
          numberBadge.className = "absolute left-1 top-1 flex h-4 min-w-4 items-center justify-center rounded bg-slate-800 text-[10px] font-semibold text-slate-200";
          numberBadge.textContent = String(index + 1);
          const img = document.createElement("img");
          img.src = item.url;
          img.alt = item.file.name;
          img.className = "h-full w-full object-cover";
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "absolute right-1 top-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500/80 text-white text-[10px] font-bold hover:bg-red-400";
          removeBtn.innerHTML = "×";
          removeBtn.title = "移除";
          removeBtn.addEventListener("click", () => {
            previewItems = previewItems.filter((x) => x.id !== item.id);
            URL.revokeObjectURL(item.url);
            refreshPreview();
          });
          wrapper.appendChild(numberBadge);
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          previewGrid.appendChild(wrapper);
        });
        if (previewItems.length === 0) {
          previewCount.textContent = "";
          if (analyzeBtn) analyzeBtn.disabled = true;
          return;
        }
        previewCount.textContent = `已选择 ${previewItems.length} 张`;
        if (analyzeBtn) analyzeBtn.disabled = false;
      }

      function addFiles(files) {
        if (!files || !files.length) return;
        const imageFiles = Array.from(files).filter((f) => f.type.startsWith("image/"));
        if (!imageFiles.length) return;
        imageFiles.forEach((file) => {
          const id = `${file.name}-${file.lastModified}-${Math.random().toString(36).slice(2, 8)}`;
          previewItems.push({ id, file, url: URL.createObjectURL(file) });
        });
        fileName.textContent = imageFiles.length === 1 ? `已选择：${imageFiles[0].name}` : `已选择 ${imageFiles.length} 张图片`;
        refreshPreview();
      }

      input.addEventListener("change", () => addFiles(input.files));
      ["dragenter", "dragover"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add("ring-2", "ring-indigo-400/60", "border-indigo-400/60"); });
      });
      ["dragleave", "drop"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("ring-2", "ring-indigo-400/60", "border-indigo-400/60"); });
      });
      dropzone.addEventListener("drop", (e) => { const f = e.dataTransfer?.files; if (f?.length) addFiles(f); });

      // 开始解析 → 填充 #chineseRef 与 #japaneseFinal
      analyzeBtn.addEventListener("click", async () => {
        if (analyzeLoading || previewItems.length === 0) return;
        const file = previewItems[0].file;
        const formData = new FormData();
        formData.append("image", file);
        analyzeLoading = true;
        analyzeBtn.disabled = true;
        analyzeBtnText.textContent = "AI 正在思考中...";
        analyzeBtnSpinner.classList.remove("hidden");
        try {
          const res = await fetch("/analyze-product", { method: "POST", body: formData });
          const json = await res.json();
          if (!res.ok) {
            alert("解析失败：\n" + (json.message || json.error || "请求失败"));
            return;
          }
          if (!json.success || !json.data) {
            alert("解析失败：服务器返回数据异常");
            return;
          }
          const data = json.data;
          const chineseIntro = (data.chinese && data.chinese["产品简介"] != null) ? String(data.chinese["产品简介"]) : "";
          const chinesePoints = Array.isArray(data.chinese && data.chinese["核心卖点"]) ? data.chinese["核心卖点"] : [];
          const chineseText = [chineseIntro, ...chinesePoints].filter(Boolean).join("\n\n");
          chineseRef.textContent = chineseText;

          let japaneseIntro = (data.japanese && data.japanese["本土化简介"] != null) ? String(data.japanese["本土化简介"]).trim() : "";
          let japanesePoints = Array.isArray(data.japanese?.["本土化卖点"]) ? data.japanese["本土化卖点"] : [];
          if (!data.japanese && Array.isArray(data["核心卖点"])) {
            japanesePoints = data["核心卖点"];
            japaneseIntro = data["产品名称"] != null ? String(data["产品名称"]) : "";
          }
          const japaneseText = [japaneseIntro, ...japanesePoints.map((p) => String(p).trim())].filter(Boolean).join("\n\n");
          japaneseFinal.textContent = japaneseText;
        } catch (e) {
          alert("解析失败：\n" + (e.message || "网络错误"));
        } finally {
          analyzeLoading = false;
          analyzeBtn.disabled = previewItems.length === 0;
          analyzeBtnText.textContent = "开始解析";
          analyzeBtnSpinner.classList.add("hidden");
        }
      });

      // ---------- 右侧卡片：加载态 / 结果渲染 / 重绘 ----------
      function setCardLoading(cardIndex) {
        const el = document.getElementById(`card${cardIndex}Image`);
        if (!el) return;
        el.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/60 flex card-image-loading text-slate-300 text-sm";
        el.innerHTML = '<div class="spinner" aria-hidden="true"></div><span>AI 正在作画中...</span><div class="progress-bar"><div class="progress-bar-inner"></div></div>';
      }

      function setCardResult(cardIndex, url, promptText) {
        const imageEl = document.getElementById(`card${cardIndex}Image`);
        const promptEl = document.getElementById(`card${cardIndex}Prompt`);
        const redrawBtn = document.getElementById(`card${cardIndex}Redraw`);
        if (imageEl) {
          imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 overflow-hidden flex items-center justify-center";
          imageEl.innerHTML = '';
          if (url) {
            const img = document.createElement('img');
            img.src = url;
            img.alt = '生成图';
            img.className = 'w-full h-full object-contain';
            imageEl.appendChild(img);
          } else {
            const span = document.createElement('span');
            span.className = 'text-amber-400 text-sm';
            span.textContent = '生成失败';
            imageEl.appendChild(span);
          }
        }
        if (promptEl) promptEl.value = promptText || '';
        if (redrawBtn) {
          redrawBtn.disabled = !url;
          if (url) redrawBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          else redrawBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }

      function setRedrawButtonsEnabled(enabled) {
        [1, 2, 3].forEach((i) => {
          const btn = document.getElementById(`card${i}Redraw`);
          if (btn) {
            btn.disabled = !enabled;
            if (enabled) btn.classList.remove('opacity-50', 'cursor-not-allowed');
            else btn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        });
      }

      // ---------- 历史记录侧边栏 ----------
      function openHistorySidebar() {
        historySidebar.classList.remove('hidden');
        historySidebar.setAttribute('aria-hidden', 'false');
        historyOverlay.classList.remove('hidden');
        historyOverlay.setAttribute('aria-hidden', 'false');
      }
      function closeHistorySidebar() {
        historySidebar.classList.add('hidden');
        historySidebar.setAttribute('aria-hidden', 'true');
        historyOverlay.classList.add('hidden');
        historyOverlay.setAttribute('aria-hidden', 'true');
      }

      function formatHistoryTime(createdAt) {
        if (!createdAt) return '';
        const d = new Date(createdAt);
        const now = new Date();
        const sameDay = d.toDateString() === now.toDateString();
        if (sameDay) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        return d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      }

      function fillFromHistory(row) {
        chineseRef.textContent = row.chinese_text || '';
        japaneseFinal.textContent = row.japanese_text || '';
        let urls = [];
        let prompts = [];
        try {
          if (row.image_urls) urls = JSON.parse(row.image_urls);
          if (row.prompts_json) prompts = JSON.parse(row.prompts_json);
        } catch (e) {}
        [1, 2, 3].forEach((i) => setCardResult(i, urls[i - 1] || null, prompts[i - 1] || ''));
        closeHistorySidebar();
      }

      async function loadHistory() {
        historyLoading.classList.remove('hidden');
        historyEmpty.classList.add('hidden');
        historyList.querySelectorAll('.history-item').forEach((el) => el.remove());
        try {
          const res = await fetch('/api/history');
          const rows = await res.json();
          historyLoading.classList.add('hidden');
          if (!Array.isArray(rows) || rows.length === 0) {
            historyEmpty.classList.remove('hidden');
            return;
          }
          rows.slice(0, 10).forEach((row) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'history-item w-full text-left rounded-lg border border-slate-700 bg-slate-800/60 px-3 py-2.5 hover:bg-slate-700/80 focus:outline-none focus:ring-2 focus:ring-indigo-500/50';
            const name = document.createElement('div');
            name.className = 'text-sm font-medium text-slate-200 truncate';
            name.textContent = row.product_name || '（未命名）';
            const time = document.createElement('div');
            time.className = 'text-xs text-slate-400 mt-0.5';
            time.textContent = formatHistoryTime(row.created_at);
            item.appendChild(name);
            item.appendChild(time);
            item.addEventListener('click', () => fillFromHistory(row));
            historyList.appendChild(item);
          });
        } catch (e) {
          historyLoading.classList.add('hidden');
          historyEmpty.classList.remove('hidden');
          historyEmpty.textContent = '加载失败';
        }
      }

      historyToggle.addEventListener('click', () => { openHistorySidebar(); loadHistory(); });
      historyClose.addEventListener('click', closeHistorySidebar);
      historyOverlay.addEventListener('click', closeHistorySidebar);

      document.addEventListener('DOMContentLoaded', loadHistory);

      // 确认文案并生成全套组图
      let generateLoading = false;
      confirmAndGenerate.addEventListener("click", async () => {
        const japaneseText = (japaneseFinal.innerText || japaneseFinal.textContent || '').trim();
        if (!japaneseText) {
          alert('请先填写或解析出「日文本土化文案」后再生成。');
          return;
        }
        if (generateLoading) return;
        generateLoading = true;
        confirmAndGenerate.disabled = true;
        [1, 2, 3].forEach(setCardLoading);
        setRedrawButtonsEnabled(false);
        try {
          const productName = previewItems.length > 0 ? (previewItems[0].file.name || '').trim() : '';
          const chineseText = (chineseRef.textContent || '').trim();
          const res = await fetch('/generate-all-visuals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ japaneseText, product_name: productName, chineseText }),
          });
          const json = await res.json();
          if (!res.ok) {
            alert('生成失败：' + (json.message || json.error || res.statusText));
            [1, 2, 3].forEach((i) => setCardResult(i, null, ''));
            return;
          }
          if (!json.success || !Array.isArray(json.data)) {
            alert('生成失败：返回数据异常');
            [1, 2, 3].forEach((i) => setCardResult(i, null, ''));
            return;
          }
          const data = json.data;
          data.forEach((item, index) => {
            const i = index + 1;
            setCardResult(i, item.url || null, item.prompt || '');
          });
        } catch (e) {
          alert('生成失败：' + (e.message || '网络错误'));
          [1, 2, 3].forEach((i) => setCardResult(i, null, ''));
        } finally {
          generateLoading = false;
          confirmAndGenerate.disabled = false;
        }
      });

      // 修改提示词并单独重绘：调用 /regenerate-single，按 type 更新对应卡片图片
      const cardTypes = { 1: '白底图', 2: '卖点图', 3: '场景图' };
      [1, 2, 3].forEach((i) => {
        const btn = document.getElementById(`card${i}Redraw`);
        const promptEl = document.getElementById(`card${i}Prompt`);
        const imageEl = document.getElementById(`card${i}Image`);
        if (!btn || !promptEl) return;
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.addEventListener('click', async () => {
          const prompt = promptEl.value.trim();
          if (!prompt) {
            alert('请先填写或生成生图提示词后再重绘。');
            return;
          }
          btn.disabled = true;
          setCardLoading(i);
          try {
            const res = await fetch('/regenerate-single', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, type: cardTypes[i] }),
            });
            const json = await res.json();
            if (!json.success) {
              alert('重绘失败：' + (json.message || '未知错误'));
              if (imageEl) {
                imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-amber-400 text-sm";
                imageEl.textContent = '重绘失败';
              }
              return;
            }
            if (imageEl && json.url) {
              imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 overflow-hidden flex items-center justify-center";
              imageEl.innerHTML = '';
              const img = document.createElement('img');
              img.src = json.url;
              img.alt = '重绘图';
              img.className = 'w-full h-full object-contain';
              imageEl.appendChild(img);
            }
          } catch (e) {
            alert('重绘失败：' + (e.message || '网络错误'));
            if (imageEl) {
              imageEl.className = "mt-3 min-h-[180px] rounded-lg border border-white/10 bg-slate-800/50 flex items-center justify-center text-amber-400 text-sm";
              imageEl.textContent = '重绘失败';
            }
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        });
      });
    </script>
  </body>
</html>
