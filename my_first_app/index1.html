<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 电商视觉生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .result-editable.modified { border-color: rgba(99, 102, 241, 0.6); box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3); }
      .result-cell-editable .result-modified-hint:not(.hidden) { display: inline-block; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 antialiased">
    <!-- Top Nav -->
    <header class="sticky top-0 z-50 border-b border-white/10 bg-slate-950/80 backdrop-blur">
      <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-4 sm:px-6">
        <div class="flex items-center gap-3">
          <div
            class="grid h-9 w-9 place-items-center rounded-xl bg-gradient-to-br from-indigo-500 to-cyan-400 text-slate-950 font-black"
            aria-hidden="true"
          >
            AI
          </div>
          <h1 class="text-lg font-semibold tracking-tight sm:text-xl">AI 电商视觉生成器</h1>
        </div>
        <div class="hidden items-center gap-2 sm:flex">
          <span class="text-xs text-slate-300">上传白底图 → 解析卖点 → 生成场景图/详情页</span>
        </div>
      </div>
    </header>

    <main class="mx-auto w-full max-w-7xl px-4 py-6 sm:px-6">
      <!-- Upload Area -->
      <section class="mb-6">
        <div
          class="group relative overflow-hidden rounded-2xl border border-white/10 bg-white/5 shadow-[0_1px_0_0_rgba(255,255,255,0.06)_inset] transition hover:bg-white/7"
        >
          <label
            for="file"
            class="block cursor-pointer p-6 sm:p-8"
            aria-label="点击或拖拽上传产品白底图"
          >
            <div
              id="dropzone"
              class="flex min-h-44 flex-col items-center justify-center rounded-xl border-2 border-dashed border-white/20 bg-slate-900/40 px-6 py-10 text-center transition group-hover:border-indigo-400/60 group-hover:bg-slate-900/60"
            >
              <div class="mb-3 rounded-2xl border border-white/10 bg-white/5 p-3">
                <svg
                  class="h-7 w-7 text-slate-200"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <path
                    d="M12 16V8m0 0l-3 3m3-3l3 3"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M20 16.5c0 2-1.5 3.5-3.5 3.5h-9C5.5 20 4 18.5 4 16.5c0-1.9 1.4-3.4 3.2-3.5.6-2.5 2.8-4.4 5.5-4.4 2.9 0 5.3 2.1 5.7 4.9 1.4.4 2.6 1.6 2.6 3.5Z"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
              <p class="text-base font-semibold text-slate-100 sm:text-lg">点击或拖拽上传产品白底图</p>
              <p class="mt-1 text-sm text-slate-300">支持 PNG / JPG，建议方图或 3:4 竖图。</p>
              <p id="fileName" class="mt-3 text-xs text-slate-400"></p>

              <div class="mt-6 flex flex-wrap items-center justify-center gap-2">
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"
                  >自动抠图</span
                >
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"
                  >卖点提取</span
                >
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"
                  >场景合成</span
                >
                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-200"
                  >详情页排版</span
                >
              </div>
            </div>
          </label>
          <input id="file" type="file" accept="image/*" multiple class="sr-only" />
        </div>

        <!-- Preview Grid -->
        <div class="mt-4 rounded-2xl border border-dashed border-white/15 bg-slate-900/40 p-4">
          <div class="mb-2 flex items-center justify-between gap-2">
            <p class="text-xs font-medium text-slate-200">
              预览（最多展示前 20 张）
            </p>
            <p id="previewCount" class="text-[11px] text-slate-400"></p>
          </div>
          <div
            id="previewGrid"
            class="flex flex-wrap justify-start gap-[12px]"
          ></div>
          <div class="mt-4 flex justify-start">
            <button
              id="analyzeBtn"
              type="button"
              disabled
              class="analyze-btn inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-500 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/70 focus:ring-offset-2 focus:ring-offset-slate-950 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:bg-indigo-500"
            >
              <span id="analyzeBtnText">开始解析</span>
              <svg id="analyzeBtnSpinner" class="hidden h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>
        </div>
      </section>

      <!-- Content Layout -->
      <section class="grid gap-6 lg:grid-cols-12">
        <!-- Sidebar: Selling Points -->
        <aside class="lg:col-span-4">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-semibold tracking-tight">产品卖点</h2>
              <span class="rounded-full border border-white/10 bg-white/5 px-2.5 py-1 text-xs text-slate-300"
                >AI 解析</span
              >
            </div>
            <p class="mt-1 text-sm text-slate-300">上传图片后点击「开始解析」，这里会展示中日本土化对照。</p>

            <!-- 结果展示：左右对照 + 同步滚动 -->
            <div id="resultCompareWrapper" class="mt-4 max-h-[420px] overflow-auto rounded-xl border border-white/10">
              <div class="grid min-h-0 grid-cols-2 gap-0 border-b border-white/10">
                <div class="border-r border-white/10 bg-slate-700/40 px-3 py-2 text-xs font-medium text-slate-400">
                  中文预览
                </div>
                <div class="flex items-center gap-2 bg-slate-800/60 px-3 py-2 text-xs font-medium text-slate-300">
                  <span>日文输出</span>
                  <span class="text-[10px] text-slate-500">✏️ 可编辑</span>
                </div>
              </div>
              <div id="resultCompareBody" class="grid min-h-0 grid-cols-2 gap-0">
                <!-- 第 1 行：简介 -->
                <div class="border-b border-r border-white/10 bg-slate-800/30 p-3">
                  <div id="devChineseIntro" class="min-h-[3.5rem] text-xs leading-relaxed text-slate-400"></div>
                </div>
                <div class="result-cell-editable border-b border-white/10 bg-slate-900/50 p-3" data-hint="intro">
                  <div
                    id="productIntro"
                    contenteditable="true"
                    class="result-editable min-h-[3.5rem] rounded-lg border border-white/10 bg-slate-800/80 px-2.5 py-2 text-sm leading-relaxed text-slate-100 outline-none transition-colors focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50"
                    data-placeholder="解析后将显示本土化简介"
                  ></div>
                  <span class="result-modified-hint hidden text-[10px] text-indigo-400">已修改</span>
                </div>
                <!-- 卖点行由 JS 动态插入到 resultCompareBody 内，保持 左|右 成对 -->
              </div>
            </div>
            <ul id="sellingPointsList" class="hidden" aria-hidden="true"></ul>

            <div class="mt-4">
              <label for="promptText" class="block text-xs font-medium text-slate-300">生图提示词（可复制）</label>
              <textarea
                id="promptText"
                readonly
                rows="4"
                class="mt-1.5 w-full resize-none rounded-xl border border-white/10 bg-slate-900/30 px-3 py-2.5 text-sm text-slate-200 placeholder-slate-500 focus:border-indigo-500/50 focus:outline-none focus:ring-1 focus:ring-indigo-500/50"
                placeholder="解析后将显示 AI 建议的生图提示词"
              ></textarea>
            </div>

            <div class="mt-5 flex flex-col gap-2 sm:flex-row">
              <button
                id="generateSceneBtn"
                type="button"
                class="inline-flex items-center justify-center rounded-xl bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/70 focus:ring-offset-2 focus:ring-offset-slate-950"
              >
                生成场景图
              </button>
              <button
                type="button"
                class="inline-flex items-center justify-center rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/20 focus:ring-offset-2 focus:ring-offset-slate-950"
              >
                生成详情页
              </button>
            </div>
          </div>
        </aside>

        <!-- Main Showcase -->
        <section class="lg:col-span-8">
          <div class="grid gap-6">
            <!-- Scene Image Placeholder -->
            <div class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
              <div class="flex items-center justify-between">
                <h2 class="text-base font-semibold tracking-tight">场景图</h2>
                <span class="text-xs text-slate-400">占位符</span>
              </div>
              <div
                class="mt-4 grid min-h-64 place-items-center rounded-xl border border-white/10 bg-gradient-to-br from-slate-900/70 to-slate-900/20"
              >
                <div class="text-center">
                  <p class="text-sm font-semibold text-slate-100">场景图预览区域</p>
                  <p class="mt-1 text-xs text-slate-300">这里将展示 AI 合成的场景图。</p>
                </div>
              </div>
            </div>

            <!-- Product Detail Page Placeholder -->
            <div class="rounded-2xl border border-white/10 bg-white/5 p-5 sm:p-6">
              <div class="flex items-center justify-between">
                <h2 class="text-base font-semibold tracking-tight">详情页</h2>
                <span class="text-xs text-slate-400">占位符</span>
              </div>
              <div class="mt-4 rounded-xl border border-white/10 bg-slate-900/30 p-4 sm:p-5">
                <div class="grid gap-4 sm:grid-cols-2">
                  <div class="rounded-lg border border-white/10 bg-white/5 p-4">
                    <p class="text-xs text-slate-300">模块 1</p>
                    <p class="mt-1 text-sm font-semibold">主视觉 Banner</p>
                    <div class="mt-3 h-24 rounded-md border border-white/10 bg-slate-900/40"></div>
                  </div>
                  <div class="rounded-lg border border-white/10 bg-white/5 p-4">
                    <p class="text-xs text-slate-300">模块 2</p>
                    <p class="mt-1 text-sm font-semibold">核心卖点排版</p>
                    <div class="mt-3 h-24 rounded-md border border-white/10 bg-slate-900/40"></div>
                  </div>
                  <div class="rounded-lg border border-white/10 bg-white/5 p-4">
                    <p class="text-xs text-slate-300">模块 3</p>
                    <p class="mt-1 text-sm font-semibold">细节图 / 参数</p>
                    <div class="mt-3 h-24 rounded-md border border-white/10 bg-slate-900/40"></div>
                  </div>
                  <div class="rounded-lg border border-white/10 bg-white/5 p-4">
                    <p class="text-xs text-slate-300">模块 4</p>
                    <p class="mt-1 text-sm font-semibold">对比 / 证据链</p>
                    <div class="mt-3 h-24 rounded-md border border-white/10 bg-slate-900/40"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <footer class="border-t border-white/10 bg-slate-950/60">
      <div class="mx-auto max-w-7xl px-4 py-6 text-xs text-slate-400 sm:px-6">
        提示：这是纯静态页面结构示例，可在此基础上接入上传、AI 解析与生成接口。
      </div>
    </footer>

    <script>
      const input = document.getElementById("file");
      const dropzone = document.getElementById("dropzone");
      const fileName = document.getElementById("fileName");
      const previewGrid = document.getElementById("previewGrid");
      const previewCount = document.getElementById("previewCount");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const analyzeBtnText = document.getElementById("analyzeBtnText");
      const analyzeBtnSpinner = document.getElementById("analyzeBtnSpinner");
      const productIntroEl = document.getElementById("productIntro");
      const sellingPointsList = document.getElementById("sellingPointsList");
      const promptText = document.getElementById("promptText");
      const generateSceneBtn = document.getElementById("generateSceneBtn");

      if (productIntroEl) {
        productIntroEl.addEventListener("input", function () {
          this.classList.add("modified");
          this.closest(".result-cell-editable")?.querySelector(".result-modified-hint")?.classList.remove("hidden");
        });
      }

      /** @type {Array<{id:string, file:File, url:string}>} */
      let previewItems = [];
      let analyzeLoading = false;

      function refreshPreview() {
        // 仅清空网格并重新渲染；URL 只在用户点击「移除」时 revoke，避免误回收导致缩略图不显示
        previewGrid.innerHTML = "";

        const visibleItems = previewItems.slice(0, 20);
        visibleItems.forEach((item, index) => {
          const wrapper = document.createElement("div");
          wrapper.id = item.id;
          wrapper.className =
            "relative h-24 w-24 sm:h-28 sm:w-28 md:h-32 md:w-32 overflow-hidden rounded-xl border border-white/10 bg-slate-900/60 shadow-sm";

          const numberBadge = document.createElement("span");
          numberBadge.className =
            "absolute left-1.5 top-1.5 inline-flex h-5 min-w-5 items-center justify-center rounded-md bg-slate-800/90 px-1 text-xs font-semibold text-slate-200 shadow";
          numberBadge.textContent = String(index + 1);
          numberBadge.title = `编号 ${index + 1}，可在提示词中引用`;

          const img = document.createElement("img");
          img.src = item.url;
          img.alt = item.file.name;
          img.className = "h-full w-full object-cover object-center";

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className =
            "absolute right-1.5 top-1.5 inline-flex h-5 w-5 items-center justify-center rounded-full bg-red-500/80 text-[10px] font-bold text-white shadow hover:bg-red-400 focus:outline-none focus:ring-2 focus:ring-red-400/70";
          removeBtn.innerHTML = "×";
          removeBtn.title = "移除该图片";
          removeBtn.addEventListener("click", () => {
            // 从列表中移除
            previewItems = previewItems.filter((x) => x.id !== item.id);
            URL.revokeObjectURL(item.url);
            refreshPreview();
          });

          wrapper.appendChild(numberBadge);
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          previewGrid.appendChild(wrapper);
        });

        if (previewItems.length === 0) {
          previewCount.textContent = "";
          if (analyzeBtn) analyzeBtn.disabled = true;
          return;
        }
        previewCount.textContent = `已选择 ${previewItems.length} 张图片`;
        if (analyzeBtn) analyzeBtn.disabled = false;
      }

      function addFiles(files) {
        if (!files || !files.length) return;

        const imageFiles = Array.from(files).filter((f) => f.type.startsWith("image/"));
        if (!imageFiles.length) return;

        imageFiles.forEach((file) => {
          const id = `${file.name}-${file.lastModified}-${Math.random().toString(36).slice(2, 8)}`;
          const url = URL.createObjectURL(file);
          previewItems.push({ id, file, url });
        });

        if (imageFiles.length === 1) {
          setName(imageFiles[0]);
        } else {
          fileName.textContent = `已选择 ${imageFiles.length} 张图片`;
        }

        refreshPreview();
      }

      function setName(file) {
        if (!file) {
          fileName.textContent = "";
          return;
        }
        fileName.textContent = `已选择：${file.name}`;
      }

      input.addEventListener("change", () => addFiles(input.files));

      // Lightweight drag&drop UX (optional)
      ["dragenter", "dragover"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.add("ring-2", "ring-indigo-400/60", "border-indigo-400/60");
        });
      });
      ["dragleave", "drop"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.remove("ring-2", "ring-indigo-400/60", "border-indigo-400/60");
        });
      });
      dropzone.addEventListener("drop", (e) => {
        const files = e.dataTransfer?.files;
        if (!files || !files.length) return;
        addFiles(files);
      });

      // 开始解析：将第一张图片发送到 /analyze-product，并渲染结果到侧边栏
      analyzeBtn.addEventListener("click", async () => {
        if (analyzeLoading || previewItems.length === 0) return;

        const file = previewItems[0].file;
        const formData = new FormData();
        formData.append("image", file);

        analyzeLoading = true;
        analyzeBtn.disabled = true;
        analyzeBtnText.textContent = "AI 正在思考中...";
        analyzeBtnSpinner.classList.remove("hidden");

        try {
          const res = await fetch("/analyze-product", {
            method: "POST",
            body: formData,
          });
          const json = await res.json();

          if (!res.ok) {
            const msg = json.message || json.error || "请求失败，请稍后重试";
            alert("解析失败：\n" + msg);
            return;
          }

          if (!json.success || !json.data) {
            alert("解析失败：服务器返回数据异常");
            return;
          }

          const data = json.data;
          const devChineseIntro = document.getElementById("devChineseIntro");
          const resultCompareBody = document.getElementById("resultCompareBody");

          const chineseIntro = (data.chinese && data.chinese["产品简介"] != null) ? String(data.chinese["产品简介"]) : "";
          const chinesePoints = Array.isArray(data.chinese && data.chinese["核心卖点"]) ? data.chinese["核心卖点"] : [];
          let japaneseIntro = (data.japanese && data.japanese["本土化简介"] != null) ? String(data.japanese["本土化简介"]).trim() : "";
          let japanesePoints = Array.isArray(data.japanese && data.japanese["本土化卖点"]) ? data.japanese["本土化卖点"] : [];
          if (!data.japanese && Array.isArray(data["核心卖点"])) {
            japanesePoints = data["核心卖点"];
            japaneseIntro = (data["产品名称"] != null) ? String(data["产品名称"]) : "";
          }

          devChineseIntro.textContent = chineseIntro;
          productIntroEl.textContent = japaneseIntro;
          productIntroEl.classList.remove("modified");
          productIntroEl.closest(".result-cell-editable")?.querySelector(".result-modified-hint")?.classList.add("hidden");

          // 移除旧的卖点行（仅保留前两个子节点：简介左|右）
          while (resultCompareBody.children.length > 2) {
            resultCompareBody.lastElementChild.remove();
          }

          const pointsToShow = Math.max(chinesePoints.length, japanesePoints.length);
          for (let i = 0; i < Math.min(pointsToShow, 4); i++) {
            const leftCell = document.createElement("div");
            leftCell.className = "border-b border-r border-white/10 bg-slate-800/30 p-3 text-xs leading-relaxed text-slate-400";
            leftCell.textContent = chinesePoints[i] != null ? String(chinesePoints[i]).trim() : "";

            const rightCell = document.createElement("div");
            rightCell.className = "result-cell-editable border-b border-white/10 bg-slate-900/50 p-3";
            const wrap = document.createElement("div");
            wrap.className = "flex items-start gap-2";
            const icon = document.createElement("span");
            icon.className = "shrink-0 text-sm opacity-70";
            icon.textContent = "✏️";
            icon.title = "可编辑";
            const editable = document.createElement("div");
            editable.contentEditable = "true";
            editable.className = "result-editable result-point-editable min-h-[1.5rem] flex-1 rounded-lg border border-white/10 bg-slate-800/80 px-2.5 py-2 text-xs leading-relaxed text-slate-100 outline-none transition-colors focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50";
            editable.textContent = (japanesePoints[i] != null ? String(japanesePoints[i]).trim() : "");
            const hint = document.createElement("span");
            hint.className = "result-modified-hint hidden text-[10px] text-indigo-400";
            hint.textContent = "已修改";
            wrap.appendChild(icon);
            wrap.appendChild(editable);
            rightCell.appendChild(wrap);
            rightCell.appendChild(hint);

            editable.addEventListener("input", function () {
              this.classList.add("modified");
              rightCell.querySelector(".result-modified-hint")?.classList.remove("hidden");
            });

            resultCompareBody.appendChild(leftCell);
            resultCompareBody.appendChild(rightCell);
          }

          promptText.value = data["建议的生图提示词"] != null ? String(data["建议的生图提示词"]) : "";
        } catch (e) {
          alert("解析失败：\n" + (e.message || "网络错误，请检查后端是否启动"));
        } finally {
          analyzeLoading = false;
          analyzeBtn.disabled = previewItems.length === 0;
          analyzeBtnText.textContent = "开始解析";
          analyzeBtnSpinner.classList.add("hidden");
        }
      });

      // 读取当前结果区中用户编辑后的内容（产品简介 + 卖点），供「生成场景图」等使用
      function getEditedResult() {
        const productIntro = (productIntroEl && productIntroEl.textContent) ? productIntroEl.textContent.trim() : "";
        const sellingPoints = [];
        const body = document.getElementById("resultCompareBody");
        if (body) {
          body.querySelectorAll(".result-point-editable").forEach((el) => {
            const t = el.textContent ? el.textContent.trim() : "";
            sellingPoints.push(t);
          });
        }
        return { productIntro, sellingPoints };
      }

      // 生成场景图：读取当前编辑后的文案（产品简介、卖点），而非原始 AI 结果
      generateSceneBtn.addEventListener("click", () => {
        const { productIntro, sellingPoints } = getEditedResult();
        const prompt = promptText.value ? promptText.value.trim() : "";
        // 后续接入生图接口时，将 productIntro、sellingPoints、prompt 一并传入
        console.log("生成场景图 - 当前文案：", { productIntro, sellingPoints, prompt });
        alert("已读取您修改后的文案（产品简介 + " + sellingPoints.length + " 条卖点）。生图接口接入后将使用这些内容发起请求。");
      });
    </script>
  </body>
</html>

